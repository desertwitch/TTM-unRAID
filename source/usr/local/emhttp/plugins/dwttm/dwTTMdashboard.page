Menu="Buttons:199"
Link="nav-user"
---
<?if(version_compare(parse_ini_file('/etc/unraid-version')['version'],'6.12.0-beta5', '>')):?>
<?if(stripos($path, "dashboard") !== false):?>
<?
    $dwttm_tmp_cfg = @parse_ini_file("/boot/config/plugins/dwttm/dwttm.cfg");
    $dwttm_tmp_running = !empty(shell_exec("pgrep -x ttmd 2>/dev/null"));
    $dwttm_tmp_os_dashboard = trim(isset($dwttm_tmp_cfg['OSDASHBOARD']) ? htmlspecialchars($dwttm_tmp_cfg['OSDASHBOARD']) : 'enable');
?>
<?if($dwttm_tmp_running && $dwttm_tmp_os_dashboard === "enable"):?>
<?
$pluginname = "dwttm";
$mytiles[$pluginname]['column2'] =
<<<EOT
<tbody id="dwttm-dashboard" title="Tmux Terminal Manager (TTM)">
    <tr>
        <td>
            <i class="fa fa-tty f32"></i>
                <div class="section">Tmux Terminal Manager (TTM)<br>
		            <span>There are <span class="dwttm-sessions" style="font-weight:bold;"><i class="fa fa-spinner fa-spin icon"></i></span> active persistent terminal sessions.</span>
                </div>
            <a href="/Dashboard/dwTTM" title="_(Go to TTM Settings)_"><i class="fa fa-fw fa-cog control"></i></a>
            <a href="#" title="_(Open TTerminal)_" id="dwttm-tterminal-button"><i class="fa fa-fw fa-terminal control"></i></a>
        </td>
    </tr>
</tbody>
EOT;
?>

<script>
    function dwTTMDashButton() {
        const width = Math.min(screen.availWidth,1200);
        const height = Math.min(screen.availHeight,800);

        let top = (screen.height-height)/2;
        if (!top || top < 0) {top = 0;}
        let left = (screen.width-width)/2;
        if (!left || left < 0) {left = 0;}

        window.open(
            '/plugins/dwttm/tterminal.php',
            'TTerminal',
            `width=${width},height=${height},top=${top},left=${left},resizable=no,scrollbars=no`
        );
    }
    function fetchSessions() {
        $.getJSON('/plugins/dwttm/include/dwttm_sessions.php', function (data) {
            if (data.response) {
                let sessions = data.response;
                let sessionCount = 0;

                $.each(sessions, function (index, session) {
                    sessionCount++;
                });

                $('.dwttm-sessions').html(sessionCount);
            } else {
                if (data.error) {
                    console.error('Error processing sessions:', data.error)
                } else {
                    console.error('Error processing sessions, no error message.');
                }
                $('.dwttm-sessions').html("?");
            }
        }).fail(function (xhr, status, error) {
            console.error('Error fetching sessions:', error);
            $('.dwttm-sessions').html("?");
        });
        clearTimeout(timers.fetchSessions);
        timers.fetchSessions = setTimeout(fetchSessions, 5000);
    }
    $(function() {
        $('#dwttm-tterminal-button').on('click', function (event) {
            event.preventDefault();
            dwTTMDashButton();
        });
        fetchSessions();
    });
</script>

<?endif;?>
<?endif;?>
<?endif;?>
